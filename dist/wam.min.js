var WAM=WAM||{Synths:{},Effects:{},Environment:{hasMIDI:void 0!=navigator.requestMIDIAccess},utils:{},AudioContext:window.AudioContext||window.webkitAudioContext};WAM.Controller=function(mode){this.setup=function(actx,bufsize,desc,proc){this.actx=actx,this.dataChannel=new WAM.DataChannel(mode),proc&&proc.setup(this.dataChannel);var self=this;return this.dataChannel.connect(this,"pout","cout",function(e){"post"==e.verb&&"/message"==e.resource&&self.onMessage(e.data)}),new Promise(function(resolve){var msg={state:1,bufsize:bufsize,actx:actx,desc:desc};self.dataChannel.request(self,"set","/state",msg,0).then(function(desc){self.node=desc.spn,self.descriptor=desc,resolve(self)})})},this.terminate=function(){var time=this.actx.currentTime;this.dataChannel.post(this,"set","/state",{state:0},time)},this.resize=function(bufsize){var self=this;return new Promise(function(resolve){var msg={state:2,bufsize:bufsize};self.dataChannel.request(self,"set","/state",msg,0).then(function(spn){self.node=spn,resolve(self)})})},this.connect=function(srcdest){var self=this;"MIDIInput"==srcdest.constructor.name?(this.midiInput=srcdest,this.midiInput.onmidimessage=function(me){self.postMidi(me.data,me.receivedTime)}):this.node.connect(srcdest)},this.disconnect=function(){this.node.disconnect()},this.disconnectMidi=function(){this.midiInput&&(this.midiInput.onmidimessage=null),this.midiInput=null},this.setParam=function(id,value){var time=0;window.performance&&(time=performance.now()),this.dataChannel.post(this,"set","/param",{id:id,value:value},time)},this.setPatch=function(data){var time=0;window.performance&&(time=performance.now()),this.dataChannel.post(this,"set","/patch",{patch:data},time)},this.postMidi=function(msg,time){time=!time&&window.performance?performance.now():0,this.dataChannel.post(this,"post","/midi",msg,time)},this.postMessage=function(verb,res,data){var msg={verb:verb,res:res,data:data},time=performance.now();this.dataChannel.post(this,"post","/message",msg,time)},this.onMessage=function(){}};var WAM=WAM||{};WAM.Processor=function(){function numChannels(desc,inout){var n=0,ports=desc.audio[inout];return ports&&ports.forEach(function(port){n+=port.channels}),n}function pushEvent(type,data,time){var sampleOffset=(time-curtime)*msSamples|0;equeue.push({offset:sampleOffset,type:type,data:data})}function process(ape){var audio={inputs:ape.inputBuffer,outputs:ape.outputBuffer},data=equeue;if(this.onprocess(audio,data)===!1)for(var ch=0;ch<this.numOutputs;ch++)for(var outbuf=audio.outputs.getChannelData(ch),n=0,L=outbuf.length;L>n;n++)outbuf[n]=0;equeue=[],window.performance&&(curtime=performance.now())}var msSamples,spn,equeue=[],curtime=0;this.postMessage=function(verb,res,data){var msg={verb:verb,res:res,data:data};this.dataChannel.post(this,"post","/message",msg)},this.ondata=function(e){var data=e.data,res=e.resource,time=e.time;switch(e.verb){case"set":if("/state"==res)if(1==data.state){this.actx=data.actx,this.sr=data.actx.sampleRate,this.bufsize=data.bufsize,msSamples=this.sr/1e3;var desc=this.init(this.bufsize,this.sr,data.desc);desc||(desc=data.desc),desc&&"string"==typeof desc&&(desc=JSON.parse(desc)),this.numInputs=numChannels(desc,"inputs"),this.numOutputs=numChannels(desc,"outputs"),this.setupBuffers(),desc.spn=spn=data.actx.createScriptProcessor(data.bufsize,this.numInputs,this.numOutputs),desc.spn.onaudioprocess=process.bind(this),this.dataChannel.post(this,"reply","/state",desc,0,e.id)}else 0==data.state?this.terminate(time):2==data.state&&(this.bufsize=data.bufsize,spn&&(spn.disconnect(),spn.onaudioprocess=null,this.resize(this.bufsize),spn=this.actx.createScriptProcessor(data.bufsize,this.numInputs,this.numOutputs),spn.onaudioprocess=process.bind(this),this.dataChannel.post(this,"reply","/state",spn,0,e.id)));else"/param"==res?(pushEvent("param",data,time),this.onparam(data.id,data.value)):"/patch"==res&&this.onpatch(data.patch,data.patch.length);break;case"post":"/message"==res?(pushEvent("message",data,time),this.onmessage(data.verb,data.res,data.data)):"/midi"==res&&(pushEvent("midi",data,time),data.length<=3?this.onmidi(data[0],data[1]?data[1]:0,data[2]?data[2]:0):this.onsysex(data,data.length))}},this.init=function(){return null},this.terminate=function(){},this.resize=function(){},this.onparam=function(){},this.onpatch=function(){},this.onmessage=function(){},this.onmidi=function(){},this.onsysex=function(){},this.onprocess=function(){},this.setupBuffers=function(){}},WAM.Processor.prototype.setup=function(dc){this.dataChannel=dc,dc.connect(this,"cout","pout",this.ondata.bind(this))},WAM.ProcessorASMJS=function(namespace,mod){var audiobus,ibufsx,obufsx,inst=0,audiobufs=[[],[]],ns=namespace[mod];this.setup=function(dc){this.base.setup.call(this,dc),inst=wam_ctor()},this.setupBuffers=function(){if(audiobus){for(var i=0;i<this.numInputs;i++)ns._free(4*audiobufs[0][i]);for(var i=0;i<this.numOutputs;i++)ns._free(4*audiobufs[1][i])}else ibufsx=ns._malloc(this.numInputs),obufsx=ns._malloc(this.numOutputs),audiobus=ns._malloc(8),ns.setValue(audiobus,ibufsx,"i32"),ns.setValue(audiobus+4,obufsx,"i32");for(var i=0;i<this.numInputs;i++){var buf=ns._malloc(4*this.bufsize);ns.setValue(ibufsx+4*i,buf,"i32"),audiobufs[0].push(buf/4)}for(var i=0;i<this.numOutputs;i++){var buf=ns._malloc(4*this.bufsize);ns.setValue(obufsx+4*i,buf,"i32"),audiobufs[1].push(buf/4)}},this.init=function(bufsize,sr){var d=wam_init(inst,bufsize,sr,"");return d&&(d=ns.Pointer_stringify(d)),d},this.terminate=function(){wam_terminate(inst),inst=0},this.resize=function(bufsize){wam_resize(inst,bufsize)},this.onparam=function(id,value){wam_onparam(inst,id,value)},this.onpatch=function(patch,length){for(var buf=ns._malloc(length),i=0;length>i;i++)ns.setValue(buf+i,patch[i],"i8");wam_onpatch(inst,buf,length),ns._free(buf)},this.onmidi=function(status,data1,data2){wam_onmidi(inst,status,data1,data2)},this.onsysex=function(msg,length){for(var buf=ns._malloc(length),i=0;length>i;i++)ns.setValue(buf+i,msg[i],"i8");wam_onsysex(inst,buf,length),ns._free(buf)},this.onmessage=function(verb,res,data){isNaN(data)?"string"==typeof data&&wam_onmessageS(inst,verb,res,data):wam_onmessageN(inst,verb,res,data)},this.onprocess=function(audio,data){for(var i=0;i<this.numInputs;i++){var waain=audio.inputs.getChannelData(i),wamin=audiobufs[0][i];ns.HEAPF32.set(waain,wamin)}wam_onprocess(inst,audiobus,data);for(var i=0;i<this.numOutputs;i++){var waaout=audio.outputs.getChannelData(i),wamout=audiobufs[1][i];waaout.set(ns.HEAPF32.subarray(wamout,wamout+this.bufsize))}};var wam_ctor=ns.cwrap("createModule","number",[]),wam_init=ns.cwrap("wam_init",null,["number","number","number","string"]),wam_terminate=ns.cwrap("wam_terminate",null,["number"]),wam_onparam=ns.cwrap("wam_onparam",null,["number","number","number"]),wam_onmidi=ns.cwrap("wam_onmidi",null,["number","number","number","number"]),wam_onsysex=ns.cwrap("wam_onsysex",null,["number","number","number"]),wam_onprocess=ns.cwrap("wam_onprocess","number",["number","number","number"]),wam_onpatch=ns.cwrap("wam_onpatch",null,["number","number","number"]),wam_onmessageN=ns.cwrap("wam_onmessageN",null,["number","string","string","number"]),wam_onmessageS=ns.cwrap("wam_onmessageS",null,["number","string","string","string"]);try{var wam_resize=ns.cwrap("wam_resize",null,["number","number"])}catch(ex){console.dir(ex)}},WAM.ProcessorASMJS.prototype=new WAM.Processor,WAM.ProcessorASMJS.prototype.constructor=WAM.ProcessorASMJS,WAM.ProcessorASMJS.prototype.base=WAM.Processor.prototype;var WAM=WAM||{};WAM.DataChannel=function(mode){function resolveRequest(id,data){for(var i=0;i<requests.length;i++)if(requests[i].id==id){requests[i].resolve(data),requests.splice(i,1);break}}function pack(sender,verb,resource,data,time,id){return void 0==id&&(id=eventID++),void 0==time&&(time=0),{verb:verb,resource:resource,data:data,time:time,id:id,sender:sender}}mode=mode||"async";var isasync="async"==mode,endpoints=[],requests=[],eventID=1;this.connect=function(endpoint,oport,iport,ondata){iport="wamevent-"+iport,oport="wamevent-"+oport,endpoints.push({ep:endpoint,oport:oport,iport:iport,callback:ondata}),isasync&&window.addEventListener(iport,this.onevent.bind(this))},this.post=function(sender,verb,resource,data,time,idEvent){var p=pack(sender,verb,resource,data,time,idEvent);if(isasync){for(var i=0;i<endpoints.length;i++)if(endpoints[i].ep==sender){var ep=endpoints[i],e=new CustomEvent(ep.oport,{detail:p});window.dispatchEvent(e);break}}else if("reply"==verb)resolveRequest(idEvent,data);else for(var i=0;i<endpoints.length;i++){var ep=endpoints[i];ep.ep!=sender&&ep.callback&&ep.callback(p)}},this.onevent=function(e){if("reply"==e.detail.verb)resolveRequest(e.detail.id,e.detail.data);else for(var i=0;i<endpoints.length;i++){var ep=endpoints[i];ep.iport==e.type&&ep.callback&&ep.callback(e.detail)}},this.request=function(sender,verb,resource,data,time,idEvent){var self=this;return new Promise(function(resolve,reject){void 0==idEvent&&(idEvent=eventID),requests.push({id:idEvent,resolve:resolve,reject:reject}),self.post(sender,verb,resource,data,time,idEvent)})}};var WAM=WAM||{};WAM.utils=WAM.utils||{},WAM.utils.autoconnect=function(wam){WAM.Environment.context||(WAM.Environment.context=new WAM.AudioContext),wam.init(WAM.Environment.context,wam.buffersize).then(function(controller){controller.connect(WAM.Environment.context.destination)})},WAM.utils.getMidiInputs=function(callback){WAM.Environment.hasMIDI?navigator.requestMIDIAccess().then(function(midi){if("function"==typeof midi.inputs)callback(midi.inputs());else{var ports=[];if(midi.inputs&&midi.inputs.size>0)for(var it=midi.inputs.values(),port=it.next();port&&!port.done;port=it.next())ports.push(port.value);callback(ports)}},function(err){console.log(err),callback(null)}):callback(null)},WAM.utils.clamp=function(v,min,max){return min>v?min:v>max?max:v};